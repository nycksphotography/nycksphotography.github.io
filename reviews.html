<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reviews | KS Photography</title>

  <style>
    :root{
      --bg:#0b0b0b;
      --gold:#d4af37;
      --text:#f3f3f3;
      --muted:rgba(243,243,243,.72);
      --line:rgba(212,175,55,.35);
      --card: rgba(255,255,255,.02);
      --cardBorder: rgba(255,255,255,.08);
      --danger:#ff5c5c;
      --ok:#7CFFB2;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:-apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial, sans-serif;
      background:
        radial-gradient(1200px 600px at 50% 0%, rgba(212,175,55,.14), transparent 55%),
        var(--bg);
      color:var(--text);
    }
    .wrap{max-width:980px;margin:0 auto;padding:26px 18px 60px}
    .panel{
      border:1px solid var(--line);
      border-radius:22px;
      background: linear-gradient(180deg, rgba(255,255,255,.03), transparent);
      overflow:hidden;
    }
    .hero{
      padding:26px 18px 18px;
      text-align:center;
    }
    .title{
      margin:10px 0 6px;
      font-size:44px;
      letter-spacing:.8px;
      color:var(--gold);
      font-weight:900;
    }
    .subtitle{
      margin:0 auto 14px;
      max-width:760px;
      color:var(--muted);
      font-style:italic;
      font-size:16px;
      line-height:1.5;
    }
    .divider{
      height:1px;
      background:var(--line);
      margin:14px auto 0;
      max-width:760px;
    }

    .section{ padding:18px 18px 26px; }

    .card{
      max-width:760px;
      margin:0 auto;
      background: var(--card);
      border: 1px solid var(--cardBorder);
      border-radius:18px;
      padding:18px 16px;
    }

    .label{
      font-weight:900;
      letter-spacing:.2px;
      margin:2px 0 10px;
      font-size:24px;
    }

    .fieldLabel{
      font-weight:900;
      margin:18px 0 8px;
      font-size:22px;
    }

    .input, .textarea{
      width:100%;
      background: rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.08);
      color:var(--text);
      border-radius:16px;
      padding:16px 16px;
      font-size:18px;
      outline:none;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.25);
    }
    .textarea{
      min-height:120px;
      resize:vertical;
    }
    .input::placeholder, .textarea::placeholder{
      color: rgba(243,243,243,.45);
    }

    /* ⭐ Average rating card */
    .avgCard{
      max-width:760px;
      margin:0 auto 14px;
      background: linear-gradient(180deg, rgba(255,255,255,.04), transparent);
      border:1px solid rgba(212,175,55,.25);
      border-radius:18px;
      padding:14px 14px;
      text-align:center;
    }
    .avgStars{
      font-size:24px;
      color:var(--gold);
      letter-spacing:2px;
      line-height:1.1;
    }
    .avgLine{
      margin-top:6px;
      font-weight:900;
      font-size:18px;
    }
    .avgSub{
      margin-top:4px;
      color:rgba(243,243,243,.62);
      font-size:13px;
      font-weight:800;
    }

    /* Stars (selection) */
    .starsRow{
      display:flex;
      gap:8px;
      flex-wrap:nowrap;
      align-items:center;
      justify-content:space-between;
    }
    .starBtn{
      width:46px;
      height:46px;
      border-radius:14px;
      border:1px solid rgba(212,175,55,.35);
      background: rgba(255,255,255,.02);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      transition: transform .12s ease, box-shadow .12s ease, background .12s ease;
      -webkit-tap-highlight-color: transparent;
      user-select:none;
    }
    .starBtn:active{ transform: translateY(1px); }
    .starBtn.selected{
      background: rgba(212,175,55,.14);
      box-shadow: 0 8px 18px rgba(0,0,0,.35);
    }
    .starIcon{
      font-size:20px;
      color: rgba(212,175,55,.55);
      line-height:1;
    }
    .starBtn.selected .starIcon{ color: var(--gold); }

    @media (max-width: 380px){
      .starsRow{ gap:6px; }
      .starBtn{ width:42px; height:42px; }
      .starIcon{ font-size:18px; }
    }

    .starsMeta{
      margin-top:10px;
      color: var(--muted);
      font-weight:800;
      font-size:16px;
    }

    /* Buttons */
    .btnRow{
      margin-top:18px;
      display:grid;
      gap:12px;
    }

    .btn{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding:0 14px;
      height:66px;
      line-height:1.15;
      border-radius:999px;
      text-decoration:none;
      font-weight:900;
      font-size:20px;
      letter-spacing:.2px;
      background: linear-gradient(180deg, rgba(212,175,55,.95), rgba(212,175,55,.78));
      border:0;
      box-shadow: 0 14px 30px rgba(0,0,0,.35);
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      user-select:none;
      color:#111;
    }
    .btn, .btn:visited, .btn:hover, .btn:focus, .btn:active{
      color:#111 !important;
      text-decoration:none !important;
    }
    button.btn{
      appearance:none;
      -webkit-appearance:none;
      color:#111 !important;
    }

    .btnOutline{
      background: rgba(255,255,255,.02);
      color: var(--gold) !important;
      border: 1px solid var(--line);
      box-shadow:none;
      font-weight:900;
    }

    .msg{
      margin-top:12px;
      font-weight:900;
      text-align:center;
      display:none;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.02);
    }
    .msg.ok{ color: var(--ok); border-color: rgba(124,255,178,.25); }
    .msg.err{ color: var(--danger); border-color: rgba(255,92,92,.25); }

    /* Reviews list */
    .reviewsCard{
      max-width:760px;
      margin:16px auto 0;
      background: var(--card);
      border: 1px solid var(--cardBorder);
      border-radius:18px;
      padding:18px 16px;
    }
    .reviewsTitle{
      font-weight:900;
      font-size:26px;
      margin:0 0 10px;
    }
    .reviewItem{
      border-top:1px solid rgba(255,255,255,.08);
      padding:14px 0;
    }
    .reviewItem:first-of-type{ border-top:0; padding-top:6px; }
    .reviewTop{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:baseline;
      justify-content:space-between;
    }
    .reviewName{
      font-weight:900;
      font-size:18px;
    }
    .reviewStars{
      color: var(--gold);
      font-weight:900;
      letter-spacing:.5px;
      font-size:16px;
      white-space:nowrap;
    }
    .reviewText{
      margin:8px 0 0;
      color: rgba(243,243,243,.86);
      line-height:1.55;
      font-size:16px;
      white-space:pre-wrap;
    }
    .reviewDate{
      margin-top:8px;
      color: rgba(243,243,243,.55);
      font-size:12px;
    }

    .refreshRow{ margin-top:12px; }

    .hint{
      color: rgba(243,243,243,.65);
      font-weight:800;
      font-size:14px;
      line-height:1.45;
      text-align:left;
    }

    footer{
      text-align:center;
      color:rgba(243,243,243,.55);
      margin:18px 0 20px;
      font-size:13px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="panel">
      <div class="hero">
        <div class="title">Reviews</div>
        <div class="subtitle">
          We truly appreciate every review. Your feedback helps future clients feel confident, and it allows us to keep delivering unforgettable experiences.
        </div>
        <div class="divider"></div>
      </div>

      <div class="section">

        <div class="avgCard">
          <div class="avgStars" id="avgStars">★★★★★</div>
          <div class="avgLine"><span id="avgValue">–</span> / 5</div>
          <div class="avgSub"><span id="avgCount">0</span> reviews</div>
        </div>

        <div class="card">
          <div class="label">Leave a Review</div>

          <div class="fieldLabel">Your name</div>
          <input id="name" class="input" type="text" placeholder="Full name" autocomplete="name" />

          <div class="fieldLabel">Stars</div>
          <div class="starsRow" id="starsRow" aria-label="Star rating">
            <div class="starBtn" data-star="1" role="button" aria-label="1 star"><span class="starIcon">★</span></div>
            <div class="starBtn" data-star="2" role="button" aria-label="2 stars"><span class="starIcon">★</span></div>
            <div class="starBtn" data-star="3" role="button" aria-label="3 stars"><span class="starIcon">★</span></div>
            <div class="starBtn" data-star="4" role="button" aria-label="4 stars"><span class="starIcon">★</span></div>
            <div class="starBtn" data-star="5" role="button" aria-label="5 stars"><span class="starIcon">★</span></div>
          </div>
          <div class="starsMeta" id="starsMeta">Select a rating</div>

          <div class="fieldLabel">Review</div>
          <textarea id="review" class="textarea" placeholder="Write your review..."></textarea>

          <div class="btnRow">
            <button id="submitBtn" class="btn" type="button">Submit Review</button>
            <a class="btn btnOutline" href="index.html">Back to Home</a>
          </div>

          <div id="msgOk" class="msg ok">Thank you for your feedback! Your review has been submitted.</div>
          <div id="msgErr" class="msg err"></div>
        </div>

        <div class="reviewsCard">
          <div class="reviewsTitle">Recent Reviews</div>
          <div id="reviewsList"></div>

          <div class="refreshRow">
            <button id="refreshBtn" class="btn btnOutline" type="button">Refresh</button>
          </div>
        </div>

        <footer>© 2026 KS Photography</footer>
      </div>
    </div>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzphK-YtvCl37sTNd-Nx2ONXos-rd5raUTRFVBMRsVvRK4Lfgdjvow3ROz0NTNJ96aX/exec";

    let selectedStars = 0;

    const starsMeta = document.getElementById("starsMeta");
    const starBtns = Array.from(document.querySelectorAll(".starBtn"));
    const submitBtn = document.getElementById("submitBtn");
    const refreshBtn = document.getElementById("refreshBtn");

    const msgOk = document.getElementById("msgOk");
    const msgErr = document.getElementById("msgErr");

    const avgStarsEl = document.getElementById("avgStars");
    const avgValueEl = document.getElementById("avgValue");
    const avgCountEl = document.getElementById("avgCount");

    function hideMsgs(){
      msgOk.style.display = "none";
      msgErr.style.display = "none";
      msgErr.textContent = "";
    }

    function setStars(n){
      selectedStars = n;
      starBtns.forEach(btn => {
        const s = parseInt(btn.dataset.star, 10);
        btn.classList.toggle("selected", s <= n);
      });
      starsMeta.textContent = n ? `${n} / 5` : "Select a rating";
    }

    starBtns.forEach(btn => {
      btn.addEventListener("click", () => {
        const n = parseInt(btn.dataset.star, 10);
        setStars(n);
        hideMsgs();
      });
    });

    function starString(n){
      return "★".repeat(n) + "☆".repeat(5 - n);
    }

    function escapeHtml(str){
      return (str || "").toString()
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function updateAverage(rows){
      const starsList = rows
        .map(r => parseInt(r.stars, 10))
        .filter(n => !isNaN(n) && n >= 1 && n <= 5);

      const count = starsList.length;
      if(!count){
        avgValueEl.textContent = "–";
        avgCountEl.textContent = "0";
        avgStarsEl.textContent = "☆☆☆☆☆";
        return;
      }

      const avg = starsList.reduce((a,b)=>a+b,0) / count;
      const rounded = Math.round(avg * 10) / 10;

      const full = Math.round(avg);
      avgStarsEl.textContent = starString(full);
      avgValueEl.textContent = rounded.toFixed(1);
      avgCountEl.textContent = String(count);
    }

    async function loadReviews(){
      const list = document.getElementById("reviewsList");
      list.innerHTML = `<div class="hint">Loading…</div>`;

      try{
        const res = await fetch(API_URL, { method: "GET" });
        if(!res.ok) throw new Error("Bad response");

        const data = await res.json();
        const rows = Array.isArray(data.reviews) ? data.reviews : [];

        updateAverage(rows);

        if(rows.length === 0){
          list.innerHTML = `<div class="hint">No reviews yet.</div>`;
          return;
        }

        list.innerHTML = rows.map(r => {
          const name = escapeHtml(r.name || "Anonymous");
          const stars = Math.min(5, Math.max(1, parseInt(r.stars, 10) || 5));
          const review = escapeHtml(r.review || "");
          const date = r.timestamp ? new Date(r.timestamp) : null;
          const dateText = date && !isNaN(date) ? date.toLocaleDateString() : "";

          return `
            <div class="reviewItem">
              <div class="reviewTop">
                <div class="reviewName">${name}</div>
                <div class="reviewStars">${starString(stars)}</div>
              </div>
              <div class="reviewText">${review}</div>
              ${dateText ? `<div class="reviewDate">${dateText}</div>` : ``}
            </div>
          `;
        }).join("");

      }catch(err){
        avgValueEl.textContent = "–";
        avgCountEl.textContent = "–";
        avgStarsEl.textContent = "☆☆☆☆☆";

        list.innerHTML =
          `<div class="hint" style="color:rgba(255,92,92,.95);font-weight:900">
            Reviews are temporarily unavailable. Please try again later.
          </div>`;
      }
    }

    async function submitReview(){
      hideMsgs();

      const name = (document.getElementById("name").value || "").trim().slice(0, 60);
      const review = (document.getElementById("review").value || "").trim().slice(0, 1000);

      if(selectedStars === 0){
        msgErr.textContent = "Please select a star rating before submitting.";
        msgErr.style.display = "block";
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = "Submitting…";

      try{
        const payload = { name: name || "Anonymous", stars: selectedStars, review };

        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "text/plain;charset=utf-8" }, // ✅ FIX (no CORS preflight)
          body: JSON.stringify(payload),
        });

        let ok = false;
        try{
          const data = await res.json();
          ok = !!data.ok;
        }catch(e){
          ok = res.ok;
        }

        if(!ok) throw new Error("Not ok");

        msgOk.style.display = "block";

        document.getElementById("name").value = "";
        document.getElementById("review").value = "";
        setStars(0);

        await loadReviews();

      }catch(err){
        msgErr.textContent = "Could not submit your review. Please try again.";
        msgErr.style.display = "block";
      }finally{
        submitBtn.disabled = false;
        submitBtn.textContent = "Submit Review";
      }
    }

    submitBtn.addEventListener("click", submitReview);
    refreshBtn.addEventListener("click", loadReviews);

    loadReviews();
  </script>
</body>
</html>